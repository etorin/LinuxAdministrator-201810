### Резервное копирование

Настраиваем Backup
Настроить стенд Vagrant с двумя виртуальными машинами server и client.

Настроить политику бэкапа директории /etc с клиента:
1) Полный бэкап - раз в день
2) Инкрементальный - каждые 10 минут
3) Дифференциальный - каждые 30 минут

Запустить систему на два часа. Для сдачи ДЗ приложить list jobs, list files jobid=<id>
и сами конфиги bacula-*

* Настроить доп. Опции - сжатие, шифрование, дедупликация

[Инструкция][1]

По инструкции пишу Vagrant + Ansible сценарии.
Не все гладко конечно. И ошибки присутствуют конечно.
В итоге, бакула поднимается в лице fd sd dir.

И первый же тест ей мешает совершить selinux.

Отключаю, перезагружаю, вот.
```bash
[vagrant@bareos-dir ~]$ sestatus 
SELinux status:                 disabled
[vagrant@bareos-dir ~]$ sudo -s
[root@bareos-dir vagrant]# bconsole 
Connecting to Director localhost:9101
1000 OK: bacula-dir Version: 5.2.13 (19 February 2013)
Enter a period to cancel a command.
*label
Automatically selected Catalog: MyCatalog
Using Catalog "MyCatalog"
Automatically selected Storage: File
MyVolume
Defined Pools:
     1: Default
     2: File
     3: Scratch
Select the Pool (1-3): 2
Connecting to Storage daemon File at 192.168.33.12:9103 ...
Sending label command for Volume "MyVolume" Slot 0 ...
3000 OK label. VolBytes=197 DVD=0 Volume="MyVolume" Device="FileStorage" (/bacula/backup)
Catalog record for Volume "MyVolume", Slot 0  successfully created.
Requesting to mount FileStorage ...
3906 File device ""FileStorage" (/bacula/backup)" is always mounted
```

- [разобраться с selinux][2] - тут взял одну команду только (и то на каком-то форуме ее нашел)
- дописать открытие портов firewalld (есть стандартные сервисы bacula)

Одной команды оказалось достаточно что бы бакула заработала и selinux ee пустил.
Тут особенны подробностей не пишу - все по интсрукции делаю.

[Инструкция][3] - дальше нужно поставить клиент на отдельном узле.

В текущей реализации, пароль простой и я прсто в открытом виде кладу его в оба файла - на директоре и на клиенте.
В рабочем варианте, возникает необходимость синхронизировать пароли в 2х ролях, так как один файл идет на слиент, другой на сервер.
Так вот, там реализован ужастный метод получения ключа из файла, когда на сервере генерируется пароль 
и каждая роль (директор и на клиент) идет на этот хост, читает файл и присвает из stdout в переменную пароль.
Ужос, воскликните Вы. Так и есть.

**Вопрос: А как сгенерировать пароль во время выполнения сценария и положить его в переменную для 2х разных ролей?**

Наверное, не плохо бы создавать файл конфигурации для клиента на директоре в соответствующей роли директора, 
циклом по списку элементов в инвентарном файле в группе [bareos-clients], но это слишком правильно и сложно.

Поэтому, я редактирую файл клиента в роли клиента (потому что тут же сразу и все переменные клиента есть) и отправляю файл на директор.

**Вопрос: А как все-же нам собетуют конфигурировать в данном случае лучшие-практики?**

Рабочий метод, опробован не раз. Но, после загрузки, ssh требует fingerprint или наличие записи в известных хостах или что-то такое, я точно не знаю что это.
Но, без них ssh не начинается. [Исправление конфигурации][4] не помогло. Делаем [так][5] - не понятно что это, но помогло. 
Тут, кстати, неоднозначно, от какого пользователя (root или vagrant) работает delegate_to. Похоже от vagrant. 
А файл создается от root, потому что `~/.ssh/config` создал /root/.ssh/config

```bash
[root@bareos-client .ssh]# vi ~/.ssh/config
Host 192.168.33.*
   StrictHostKeyChecking no
   UserKnownHostsFile=/dev/null
```

**Вопрос: Где подробнее почитать о fingerprint и той опции, что я тут применил для обхода всего этого?**

При добавлении файла клиента на директор возник вопрос паролей.
Я считаю так. Если не верно - прошу пожалуйста поправить.

пароль директора = пароль консоли
пароль хранилища директора = пароль хранилища в отдельной секции хранилища (тк может быть другой сервер)
проль клиент в секции директора = пароль клиента на сервере клиента

Решил все в один файл положить.
Что пока не понятно. Есть клиент. У клиента есть Job. 

**Вопрос: Для каждого уровня бкапа (Full, Inc.. Diff..) отдельный Job нужен или нет?**

[Тут наглядно про уровни бэкапа][6]

**Вопрос: Для каждого уникального FileSet отдельный Job нужен или нет?**

Тоесть не понятно, что является критерием создания отдельной job.

С Schedule например такой проблемы нет. Для каждого уровня бэкапа можно определить время в рамках одного расписания. Нашел [тут][7]

**Вопрос: Почитал, и непонятно что такое пул и volume? Как пул соотносится с volume и отдельным файлом после каждого конкретного job?**

Что не получилось по Ansible:

 - использовать в одном шаге и notify и delegate_to - не работает так
 - использовать в цикле with_items внутри переменных списка - другие переменны через "{{ var }}" - нарушается синтаксис

**Вопрос: Могу ли я после full job увидеть реальные файлы скопированные с клиента?**

**Вопрос: Могу ли я после full job восстановить эти файлы в место отличное от того сервера, где они были взяты? Например на локальную машину в конкретнуюю директорию?**

```
+---------+-------------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
| MediaId | VolumeName                                                  | VolStatus | Enabled | VolBytes   | VolFiles | VolRetention | Recycle | Slot | InChanger | MediaType | LastWritten         |
+---------+-------------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
|       1 | Full-bareos-client-fd_Full_RemoteFile-Full.2019-02-27-22-25 | Append    |       1 | 21,503,353 |        0 |      864,000 |       1 |    0 |         0 | File      | 2019-02-27 22:25:15 |
+---------+-------------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
Pool: RemoteFile-Inc
+---------+-----------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
| MediaId | VolumeName                                                | VolStatus | Enabled | VolBytes   | VolFiles | VolRetention | Recycle | Slot | InChanger | MediaType | LastWritten         |
+---------+-----------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
|       2 | Inc-bareos-client-fd_Full_RemoteFile-Inc.2019-02-27-22-25 | Append    |       1 | 10,751,809 |        0 |      864,000 |       1 |    0 |         0 | File      | 2019-02-27 22:25:08 |
+---------+-----------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
Pool: RemoteFile-Diff
+---------+-------------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
| MediaId | VolumeName                                                  | VolStatus | Enabled | VolBytes   | VolFiles | VolRetention | Recycle | Slot | InChanger | MediaType | LastWritten         |
+---------+-------------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
|       3 | Diff-bareos-client-fd_Full_RemoteFile-Diff.2019-02-27-22-25 | Append    |       1 | 10,751,806 |        0 |      864,000 |       1 |    0 |         0 | File      | 2019-02-27 22:25:12 |
+---------+-------------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
*
*
*
*
*
*list volume
+---------+-------------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
| MediaId | VolumeName                                                  | VolStatus | Enabled | VolBytes   | VolFiles | VolRetention | Recycle | Slot | InChanger | MediaType | LastWritten         |
+---------+-------------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
|       1 | Full-bareos-client-fd_Full_RemoteFile-Full.2019-02-27-22-25 | Append    |       1 | 21,503,839 |        0 |      864,000 |       1 |    0 |         0 | File      | 2019-02-27 22:35:03 |
+---------+-------------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
Pool: RemoteFile-Inc
+---------+-----------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
| MediaId | VolumeName                                                | VolStatus | Enabled | VolBytes   | VolFiles | VolRetention | Recycle | Slot | InChanger | MediaType | LastWritten         |
+---------+-----------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
|       2 | Inc-bareos-client-fd_Full_RemoteFile-Inc.2019-02-27-22-25 | Append    |       1 | 10,752,289 |        0 |      864,000 |       1 |    0 |         0 | File      | 2019-02-27 22:35:05 |
+---------+-----------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
Pool: RemoteFile-Diff
+---------+-------------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
| MediaId | VolumeName                                                  | VolStatus | Enabled | VolBytes   | VolFiles | VolRetention | Recycle | Slot | InChanger | MediaType | LastWritten         |
+---------+-------------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
|       3 | Diff-bareos-client-fd_Full_RemoteFile-Diff.2019-02-27-22-25 | Append    |       1 | 10,752,292 |        0 |      864,000 |       1 |    0 |         0 | File      | 2019-02-27 22:35:08 |
+---------+-------------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
You have messages.
```

**Вопрос: Похоже все уровни бэкапа делаются одновременно, не смотря на указание уровня в Schedule. Почему? Если я разделю по разным Schedule - поможет разнести по времени?**

Вручную поотдельности dct три (4 5 6) job запустились с разными уровнями бэкапа.
```
*run
A job name must be specified.
The defined Job resources are:
     1: BackupLocalFiles
     2: BackupCatalog
     3: RestoreLocalFiles
     4: BackupClientHostEtc-Full
     5: BackupClientHostEtc-Inc
     6: BackupClientHostEtc-Diff
Select Job resource (1-6): 5
Run Backup job
JobName:  BackupClientHostEtc-Inc
Level:    Incremental
Client:   bareos-client-fd
FileSet:  etc-fileset
Pool:     RemoteFile-Inc (From Job resource)
Storage:  File (From Job resource)
When:     2019-02-27 22:42:17
Priority: 10
OK to run? (yes/mod/no): y
Job queued. JobId=12
```

А по расписанию - снова вместе.
Сделал 3 расписания - все в разное время стало копироваться.
```
+---------+-------------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
| MediaId | VolumeName                                                  | VolStatus | Enabled | VolBytes   | VolFiles | VolRetention | Recycle | Slot | InChanger | MediaType | LastWritten         |
+---------+-------------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
|       1 | Full-bareos-client-fd_Full_RemoteFile-Full.2019-02-28-20-53 | Append    |       1 | 21,503,349 |        0 |      864,000 |       1 |    0 |         0 | File      | 2019-02-28 21:00:03 |
+---------+-------------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
Pool: RemoteFile-Inc
+---------+-----------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
| MediaId | VolumeName                                                | VolStatus | Enabled | VolBytes   | VolFiles | VolRetention | Recycle | Slot | InChanger | MediaType | LastWritten         |
+---------+-----------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
|       2 | Inc-bareos-client-fd_Full_RemoteFile-Inc.2019-02-28-20-55 | Append    |       1 | 10,752,287 |        0 |      864,000 |       1 |    0 |         0 | File      | 2019-02-28 21:05:02 |
+---------+-----------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
Pool: RemoteFile-Diff
+---------+-------------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
| MediaId | VolumeName                                                  | VolStatus | Enabled | VolBytes   | VolFiles | VolRetention | Recycle | Slot | InChanger | MediaType | LastWritten         |
+---------+-------------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
|       3 | Diff-bareos-client-fd_Full_RemoteFile-Diff.2019-02-28-21-08 | Append    |       1 | 10,751,804 |        0 |      864,000 |       1 |    0 |         0 | File      | 2019-02-28 21:08:03 |
+---------+-------------------------------------------------------------+-----------+---------+------------+----------+--------------+---------+------+-----------+-----------+---------------------+
*
*list jobs
+-------+--------------------------+---------------------+------+-------+----------+------------+-----------+
| JobId | Name                     | StartTime           | Type | Level | JobFiles | JobBytes   | JobStatus |
+-------+--------------------------+---------------------+------+-------+----------+------------+-----------+
|     1 | BackupClientHostEtc-Full | 2019-02-28 20:53:38 | B    | F     |    2,399 | 10,373,336 | T         |
|     2 | BackupClientHostEtc-Inc  | 2019-02-28 20:55:02 | B    | F     |    2,399 | 10,373,336 | T         |
|     3 | BackupClientHostEtc-Full | 2019-02-28 21:00:02 | B    | F     |    2,399 | 10,373,336 | T         |
|     4 | BackupClientHostEtc-Inc  | 2019-02-28 21:05:02 | B    | I     |        0 |          0 | T         |
|     5 | BackupClientHostEtc-Diff | 2019-02-28 21:08:02 | B    | F     |    2,399 | 10,373,336 | T         |
+-------+--------------------------+---------------------+------+-------+----------+------------+-----------+
*
*
*list files jobid=5
...
| /etc/anacrontab |
| /etc/logrotate.d/yum |
| /etc/logrotate.d/syslog |
| /etc/logrotate.d/bacula |
| /etc/logrotate.d/chrony |
| /etc/request-key.d/cifs.spnego.conf |
| /etc/request-key.d/cifs.idmap.conf |
| /etc/request-key.d/id_resolver.conf |
+----------+
+-------+--------------------------+---------------------+------+-------+----------+------------+-----------+
| JobId | Name                     | StartTime           | Type | Level | JobFiles | JobBytes   | JobStatus |
+-------+--------------------------+---------------------+------+-------+----------+------------+-----------+
|     5 | BackupClientHostEtc-Diff | 2019-02-28 21:08:02 | B    | F     |    2,399 | 10,373,336 | T         |
+-------+--------------------------+---------------------+------+-------+----------+------------+-----------+
*
```
list files jobid= - очень длинный вывод, весь не стал прикладывать.

По своей задаче с резервированием, нужно еще кое какие параметры найти.
Ограничение скорости передачи данных ключ Job [Maximum Bandwidth][8]

Осталось настроить сжатие, шифрование, дедупликацию, запуск скрипта, ограничение скорости передачи данных.
Потом если время и желание будет, развернем на клиенте заббикс сервер, там база есть, ее на горячую копируем и уносим бакулой файл.

Ссылки так же полезные:
[ОСНОВНАЯ: РЕЗЕРВНОЕ КОПИРОВАНИЕ СЕРВЕРА CENTOS 7 С ПОМОЩЬЮ BACULA][13]
[Bog BOS: Сетевая система резервного копирования и восстановления данных bacula][9]
[New bacula Features in 7.0.0][10]
[New bacula Features in 5.0.0][11]
[Настройка дедупликации в bacula][12]

Потрачено времени 14:40:57

---

[1]: https://www.8host.com/blog/ustanovka-servera-bacula-v-centos-7/
[2]: https://www.systutorials.com/docs/linux/man/8-bacula_selinux/
[3]: https://www.8host.com/blog/rezervnoe-kopirovanie-servera-centos-7-s-pomoshhyu-bacula/
[4]: https://stackoverflow.com/questions/32297456/how-to-ignore-ansible-ssh-authenticity-checking
[5]: https://linuxcommando.blogspot.com/2008/10/how-to-disable-ssh-host-key-checking.html
[6]: https://www.baculasystems.com/best-enterprise-data-backup-solutions/best-incremental-vs-differential-backup-software
[7]: https://www.bacula.org/5.2.x-manuals/en/main/main/Configuring_Director.html#SECTION001450000000000000000
[8]: https://www.bacula.org/9.2.x-manuals/en/main/New_Features_in_7_0_0.html
[9]: http://www.bog.pp.ru/work/bacula.html#TLSexample
[10]: https://www.bacula.org/9.2.x-manuals/en/main/New_Features_in_7_0_0.html
[11]: https://www.bacula.org/5.2.x-manuals/en/main/main/New_Features_in_5_2_x.html
[12]: https://www.casp.ru/bacula-deduplication/
[13]: https://www.8host.com/blog/rezervnoe-kopirovanie-servera-centos-7-s-pomoshhyu-bacula/
[14]: 
[15]: 